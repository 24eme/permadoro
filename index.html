<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title></title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="" />
  <style>
    body {
      font-family: monospace;
      font-size: 4.5px;
    }
    #container {
      text-align: center;
      padding-top: 100px;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="timer" style="font-size: 24em;"></div>
    <div id="title" style="font-size: 8em; margin-top: 30px;"></div>
    <button id="enableNotifications" type="button" style="font-size: 3em; margin-top: 30px; padding: 8px;">Activer les notifications</button>
    <div style="font-size: 4.5em; margin-top: 100px; opacity: 0.4;">Prochaine p√©riode</div>
    <div id="titleNext" style="font-size: 4.5em; margin-top: 20px; opacity: 0.4;"></div>
  </div>
  <script>
    if(Notification.permission === "granted") {
      document.getElementById('enableNotifications').style.display = 'none';
    }
    document.getElementById('enableNotifications').addEventListener('click', async function(e) {
      await Notification.requestPermission();
      new Notification("Pomodoro", {
        body: 'Les notifications ont √©t√© accept√©es'
      });
    })

    let periods = [];
    const today = new Date();
    let startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 0, 0, 0);
    let endDate = startDate;
    for(j=1;j<=24;j++) {
      for(i=1; i<=4; i++) {
        startDate = endDate
        endDate = new Date(startDate.getTime() + 25*60000)
        periods.push({title: 'Pomodoro', icon: 'üçÖ', start: startDate, end: endDate, durationText: '25 min', notificationText: "On ce concentre sur sa t√¢che pendant 25 minutes, aucune disctraction !"});
        startDate = endDate
        if(i < 4) {
          endDate = new Date(startDate.getTime() + 5*60000)
          periods.push({title: 'Pause courte', icon: '‚òï', start: startDate, end: endDate, durationText: '5 min',  notificationText: "On l√®ve les mains du clavier, c'est l'heure d'une courte pause de 5 minutes !"});
        } else {
          endDate = new Date(startDate.getTime() + 15*60000)
          periods.push({title: 'Pause longue', icon: 'üèñÔ∏è', start: startDate, end: endDate, durationText: '15 min', notificationText: "Loooooonnnngue pause, 15 minutes pour chiler !"});
        }
      }
    }

    function findCurrentPeriod(date) {
      for(period of periods) {

        if(date.getTime() >= period.start.getTime() && date.getTime() < period.end.getTime()) {
          return period
        }
      }

      return null
    }

    function findNexPeriod(date) {
      let finded = false;
      for(period of periods) {
        if(finded) {
          return period;
        }
        if(date.getTime() >= period.start.getTime() && date.getTime() < period.end.getTime()) {
          finded = true;
        }
      }

      return null
    }

    let currentPeriod = findCurrentPeriod(today);

    let timer = document.querySelector("#timer");
    let title = document.querySelector("#title");
    let titleNext = document.querySelector("#titleNext");
    setInterval(function() {
      let now = new Date()
      let period = findCurrentPeriod(now);
      let nextPeriod = findNexPeriod(now);
      let duration = period.end.getTime() - now.getTime();
      let minuteRest = Math.floor(Math.round(duration / 1000) / 60)
      let secondRest = Math.round(duration / 1000) % 60
      timer.innerText = minuteRest.toString().padStart(2, "0") + ':' + secondRest.toString().padStart(2, "0")
      title.innerText = period.icon + ' ' + period.title
      document.title = period.icon + ' ' + timer.innerText
      titleNext.innerHTML = nextPeriod.icon + ' ' + nextPeriod.title + ' de ' +  nextPeriod.durationText
      if(period.start != currentPeriod.start) {
        currentPeriod = period
        new Notification(period.title, {
          body: period.icon + ' ' + period.notificationText
        });
      }
    }, 500)
  </script>
</body>
</html>
