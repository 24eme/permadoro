<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title></title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="" />
  <style>
    body {
      font-family: monospace;
      font-size: 4.5px;
    }
    #container {
      text-align: center;
      padding-top: 40px;
    }
    .switch {
      border: 1px solid #c8c8c8; font-size: 3.5em; padding: 8px 16px; color: #999C; background: #f2f2f2; text-decoration: none;
      box-shadow: inset -1px 1px 6px 2px #e8e8e8; color: #999C;
    }
    .switch.active {
      color: #000;
      background: white;
      box-shadow: none;
    }
  </style>
</head>
<body>
  <div id="container">
    <a id="switch_mondial" href="" class="switch active" style="border-radius: 16px 0 0 16px;">üåç Mondial</a><a id="switch_user" href="#start" class="switch" style="border-radius: 0 16px 16px 0; border-left: 0;">üë§ Perso #0000</a>
    <div id="timer" style="font-size: 24em; margin-top: 80px;"></div>
    <div id="title" style="font-size: 8em; margin-top: 30px;"></div>
    <button id="enableNotifications" type="button" style="font-size: 3em; margin-top: 30px; padding: 8px;">Activer les notifications</button>
    <div style="font-size: 4.5em; margin-top: 80px; opacity: 0.25;">Prochaine p√©riode</div>
    <div id="titleNext" style="font-size: 4.5em; margin-top: 20px; margin-bottom: 80px; opacity: 0.25;"></div>
    <button id="btn_share" type="button" style="font-size: 3.5em; background: #fff; border: 0; color: #000; cursor: pointer; padding: 6px 12px; border-radius: 6px;">üë• Partager ce pomodoro <strong>#0000</strong> √† plusieurs</button>
  </div>
  <script>
    if(Notification.permission === "granted") {
      document.getElementById('enableNotifications').style.display = 'none';
    }
    document.getElementById('enableNotifications').addEventListener('click', async function(e) {
      await Notification.requestPermission();
      if(Notification.permission === "granted") {
        document.getElementById('enableNotifications').style.display = 'none';
      }
    })
    document.getElementById('btn_share').addEventListener('click', async function(e) {
      await navigator.clipboard.writeText(document.location);
      alert("üìã Le lien pour partager ce pomodoro a √©t√© copi√©.\n\nüë• Il suffit de le partager pour faire ce pomodoro √† plusieurs en m√™me temps");
    });

    window.addEventListener("hashchange", function(e) {
      document.location.reload();
    });

    let periods = [];
    const today = new Date();
    let startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 0, 0, 0);

    if(window.location.hash.match(/#start/)) {
      document.location.hash = '#' + Math.round((today.getTime() - startDate.getTime()) / 1000) % 7800;
    }
    document.getElementById('switch_user').classList.remove('active')
    document.getElementById('switch_mondial').classList.add('active')
    if(window.location.hash.match(/#[0-9]+/)) {
      startDate = new Date(startDate.getTime() + parseInt(window.location.hash.replace('#', ''))*1000);
      document.getElementById('switch_user').classList.add('active')
      document.getElementById('switch_mondial').classList.remove('active')
      document.getElementById('switch_user').href = window.location.hash
      document.getElementById('switch_user').innerText = document.getElementById('switch_user').innerText.replace('#0000', window.location.hash)
      document.getElementById('btn_share').innerHTML = document.getElementById('btn_share').innerHTML.replace('#0000', window.location.hash)
    }

    let endDate = startDate;
    for(j=1;j<=24;j++) {
      for(i=1; i<=4; i++) {
        startDate = endDate
        endDate = new Date(startDate.getTime() + 25*60000)
        periods.push({title: 'Pomodoro', icon: 'üçÖ', start: startDate, end: endDate, durationText: '25 min', notificationText: "On ce concentre sur sa t√¢che pendant 25 minutes, aucune distraction !"});
        startDate = endDate
        if(i < 4) {
          endDate = new Date(startDate.getTime() + 5*60000)
          periods.push({title: 'Pause courte', icon: '‚òï', start: startDate, end: endDate, durationText: '5 min',  notificationText: "On l√®ve les mains du clavier, courte pause de 5 minutes !"});
        } else {
          endDate = new Date(startDate.getTime() + 15*60000)
          periods.push({title: 'Pause longue', icon: 'üèñÔ∏è', start: startDate, end: endDate, durationText: '15 min', notificationText: "Loooooonnnngue pause, 15 minutes pour chiler !"});
        }
      }
    }

    function findCurrentPeriod(date) {
      for(period of periods) {

        if(date.getTime() >= period.start.getTime() && date.getTime() < period.end.getTime()) {
          return period
        }
      }

      return null
    }

    function findNexPeriod(date) {
      let finded = false;
      for(period of periods) {
        if(finded) {
          return period;
        }
        if(date.getTime() >= period.start.getTime() && date.getTime() < period.end.getTime()) {
          finded = true;
        }
      }

      return null
    }

    let currentPeriod = findCurrentPeriod(today);

    let timer = document.querySelector("#timer");
    let title = document.querySelector("#title");
    let titleNext = document.querySelector("#titleNext");
    setInterval(function() {
      let now = new Date()
      let period = findCurrentPeriod(now);
      let nextPeriod = findNexPeriod(now);
      let duration = period.end.getTime() - now.getTime();
      let minuteRest = Math.floor(Math.round(duration / 1000) / 60)
      let secondRest = Math.round(duration / 1000) % 60
      timer.innerText = minuteRest.toString().padStart(2, "0") + ':' + secondRest.toString().padStart(2, "0")
      title.innerText = period.icon + ' ' + period.title
      document.title = period.icon + ' ' + timer.innerText
      titleNext.innerHTML = nextPeriod.icon + ' ' + nextPeriod.title + ' de ' +  nextPeriod.durationText
      if(period.start != currentPeriod.start) {
        currentPeriod = period
        new Notification(period.title, {
          body: period.icon + ' ' + period.notificationText
        });
      }
    }, 500)
  </script>
</body>
</html>
